[tool.coverage.run]
source = ["folder_extractor"]
branch = true
omit = [
    "*/tests/*",
    "*/__pycache__/*",
    # AI modules require google-generativeai which only works on Python 3.9+
    # These are skipped on Python 3.8 and should not affect coverage
    "*/ai_async.py",
    "*/ai_resilience.py",
    "*/preprocessor.py",
    "*/security.py",
    # API and CLI modules depend on google-generativeai (Python 3.9+)
    # These can't be tested on Python 3.8 and are excluded from coverage
    "*/api/*",
    "*/cli/app.py",
    "*/smart_sorter.py",
]

[tool.coverage.report]
exclude_lines = [
    # Standard pragma
    "pragma: no cover",

    # Don't complain about abstract methods
    "@abstractmethod",
    "raise NotImplementedError",

    # Don't complain if non-runnable code isn't run
    "if __name__ == .__main__.:",
    "if TYPE_CHECKING:",

    # Don't complain about pass statements in abstract methods
    "^\\s*pass\\s*$",

    # Don't complain about defensive assertions
    "raise AssertionError",

    # Don't complain about platform-specific code that can't be tested
    "if platform.system\\(\\) == .Windows.:",
    "if sys.platform == .win32.:",
]

fail_under = 90
show_missing = true

[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = ["test_*.py"]
python_functions = ["test_*"]
# -n auto enables parallel test execution via pytest-xdist (uses all CPU cores)
addopts = "-v --tb=short -n auto"
filterwarnings = [
    "error::DeprecationWarning",
    # Ignore DeprecationWarnings from third-party packages (httplib2/pyparsing)
    # These are triggered by google-generativeai dependencies and not our code
    "ignore::DeprecationWarning:httplib2",
    "ignore::DeprecationWarning:pyparsing",
    # Ignore Starlette deprecation warning (HTTP_422 constant renamed)
    # This is a FastAPI/Starlette internal issue, not our code
    "ignore::DeprecationWarning:starlette.*",
    "ignore:'HTTP_422_UNPROCESSABLE_ENTITY' is deprecated:DeprecationWarning",
]
markers = [
    "integration: Integration tests that test complete workflows",
    "slow: Tests that are slow to execute",
    "security: Security-related tests (Zip Slip, path traversal, etc.)",
    "watch: Watch mode tests for file system monitoring",
]

[tool.ruff]
# Line length matching Black's default
line-length = 88

# Target Python 3.8 for compatibility
target-version = "py38"

# Exclude common directories
exclude = [
    ".git",
    ".pytest_cache",
    ".ruff_cache",
    "__pycache__",
    "build",
    "dist",
    "venv",
    ".venv",
]

[tool.ruff.lint]
# Enable rule sets as requested
select = [
    "E",    # pycodestyle errors
    "F",    # Pyflakes
    "I",    # isort (import sorting)
    "B",    # flake8-bugbear (subtle bugs)
    "UP",   # pyupgrade (modernize syntax)
    "SIM",  # flake8-simplify (code simplification)
]

# Ignored rules with justification
ignore = [
    "UP045",   # Optional[X] -> X | None requires Python 3.10+, we target 3.8
    "SIM117",  # Parenthesized with statements require Python 3.9+, we target 3.8
]

# Allow auto-fixing for all enabled rules
fixable = ["ALL"]
unfixable = []

# Per-file ignores for common patterns
[tool.ruff.lint.per-file-ignores]
"__init__.py" = ["F401"]  # Allow unused imports in __init__.py
"tests/**/*.py" = ["E501", "B008"]  # Relaxed for tests (long paths, Depends in tests)
"folder_extractor/api/**/*.py" = ["B008", "UP006"]  # B008: FastAPI Depends() pattern; UP006: FastAPI/Pydantic need List[str]/Dict[str, Any] for Python 3.8

[tool.ruff.format]
# Use double quotes (Black-compatible)
quote-style = "double"

# Use spaces for indentation
indent-style = "space"

# Respect magic trailing commas
skip-magic-trailing-comma = false

# Auto-detect line endings
line-ending = "auto"
